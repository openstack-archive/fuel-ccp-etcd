dsl_version: 0.4.0
service:
  name: etcd
  antiAffinity: local
  ports:
    - {{ etcd.client_port }}
    - {{ etcd.server_port }}
  annotations:
    service:
      prometheus.io/port: "{{ etcd.client_port.cont }}"
      prometheus.io/scrape: "true"
    pod:
      pod.beta.kubernetes.io/subdomain: "etcd"
  containers:
    - name: etcd
      image: etcd
      daemon:
        files:
          - entrypoint
        # {% if security.tls.enabled %}
          - server_certificate
          - server_key
          - ca_certificate
        # {% endif %}
        command: /opt/ccp/bin/entrypoint.py --client-port {{ etcd.client_port.cont }} --server-port {{ etcd.server_port.cont }} --token {{ etcd.token }}  {% if security.tls.enabled %} --tls {% endif %}
    - name: etcd-leader-elector
      image: etcd-leader-elector
      daemon:
        # {% if security.tls.enabled %}
        files:
          - ca_certificate
        # {% endif %}
        command: /server --id=$(hostname -i) --ttl=4s --election=etcd-election --http=0.0.0.0:4040 --election-namespace={{ namespace }}
    - name: etcd-watcher
      image: etcd
      daemon:
        files:
          - watcher
        # {% if security.tls.enabled %}
          - ca_certificate
        # {% endif %}
        command: /opt/ccp/bin/watcher.py --namespace={{ namespace }} {% if security.tls.enabled %} --tls {% endif %}

files:
  entrypoint:
    path: /opt/ccp/bin/entrypoint.py
    content: etcd_start.py
    perm: "0755"
# {% if security.tls.enabled %}
  server_certificate:
    path: /etc/ccp/etcd_server_certificate.pem
    content: server.pem.j2
  server_key:
    path: /etc/ccp/etcd_server_key.pem
    content: server-key.pem.j2
  ca_certificate:
    path: /etc/ccp/ca.pem
    content: ca.pem.j2
# {% endif %}
  watcher:
    path: /opt/ccp/bin/watcher.py
    content: k8s_etcd_watcher.py
    perm: "0755"
