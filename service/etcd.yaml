dsl_version: 0.4.0
service:
  name: etcd
  kind: DaemonSet
  ports:
    - {{ etcd.client_port }}
    - {{ etcd.server_port }}
  annotations:
    service:
      prometheus.io/port: "{{ etcd.client_port.cont }}"
      prometheus.io/scrape: "true"
  containers:
    - name: etcd
      image: etcd
      probes:
        readiness:
          type: "exec"
          command: "true"
      daemon:
        files:
          - entrypoint
          - watcher
        command: /opt/ccp/bin/entrypoint.py
    - name: leader-elector
      probes:
        readiness:
          type: "exec"
          command: "true"
        liveness:
          type: "exec"
          command: "true"
      image: leader-elector
      daemon:
        command: /run.sh --election=etcd-election --http=0.0.0.0:4040 --election-namespace=ccp
    - name: etcd-watcher
      image: etcd
      daemon:
        files:
          - watcher
        command: /opt/ccp/bin/watcher.py --namespace=ccp

files:
  entrypoint:
    path: /opt/ccp/bin/entrypoint.py
    content: etcd_start.py
    perm: "0755"
  watcher:
    path: /opt/ccp/bin/watcher.py
    content: k8s-etcd-watcher.py
    perm: "0755"
